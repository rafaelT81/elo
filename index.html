<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JD Elo</title>
    <!-- Balise Favicon ajout√©e ici -->
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    
    <!-- Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import des librairies Firebase SDK v11.6.1 (ES Modules) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, query, onSnapshot, runTransaction, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase functions globally for use in the main script block
        window.firebase = {
            initializeApp,
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, setDoc, deleteDoc, collection, query, onSnapshot, runTransaction, getDoc, setLogLevel
        };
    </script>
    
    <!-- Import de jsPDF pour la g√©n√©ration de PDF -->
    <!-- NOTE: Utiliser l'acc√®s au constructeur via window.jspdf.jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Import de jspdf-autotable pour les tables PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    
    <!-- Configuration des polices et du th√®me Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5', // Indigo 600
                        'secondary': '#10b981', // Emerald 500
                        'background': '#f9fafb', // Gray 50
                        // Ajout des couleurs de podium
                        'gold': '#F5E727',
                        'silver': '#C0C0C0',
                        'bronze': '#CD7F32',
                    }
                }
            }
        }
    </script>
    <style>
        /* Animation simple de chargement pour le spinner */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        /* Style pour masquer le spinner apr√®s le chargement initial */
        #loading-spinner.hidden {
            display: none;
        }
        /* Style pour les messages de l'interface utilisateur */
        .ui-message {
            transition: opacity 0.5s ease-out;
            opacity: 1;
        }
        .ui-message.fade-out {
            opacity: 0;
        }
        /* Classe pour le texte blanc sur le bronze */
        .text-on-bronze {
            color: #f9fafb; /* White or near-white */
        }
        /* Classe pour le texte fonc√© sur l'or et l'argent */
        .text-on-light {
            color: #1f2937; /* Dark gray */
        }
        /* Masquer initialement la ligne de d√©tails (sera affich√©e via JS) */
        .detail-row.hidden {
            display: none;
        }
        
        /* Assurer que le tableau ne d√©passe pas sur mobile */
        .min-w-full {
             min-width: 100%;
        }
        
        /* Style pour la bascule personnalis√©e */
        .match-mode-toggle {
            display: flex;
            padding: 0; /* Important: Retir√© le padding ext√©rieur */
            background-color: transparent; /* Rendre le fond transparent pour que les boutons actifs le remplissent */
            border-radius: 9999px; /* rounded-full */
            overflow: hidden;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border: 4px solid #e5e7eb; /* Bordure pour encadrer l'ensemble */
        }
        .match-mode-button {
            flex-grow: 1;
            padding: 8px 16px;
            font-size: 0.875rem; /* sm:text-sm */
            font-weight: 500;
            /* Pas de border-radius ici, g√©r√© par le conteneur */
            transition: all 0.2s ease-in-out;
            text-align: center;
            cursor: pointer;
            line-height: 1.25; /* Assure un bon alignement du texte */
        }
        .match-mode-button.active {
            background-color: #4f46e5; /* primary color */
            color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .match-mode-button:not(.active) {
            color: #4b5563; /* gray-600 */
            background-color: #e5e7eb; /* gray-200 pour le fond inactif */
        }
        /* Styles sp√©cifiques pour les coins arrondis des boutons √† l'int√©rieur du conteneur */
        .match-mode-toggle .match-mode-button:first-child {
            border-top-left-radius: 9999px;
            border-bottom-left-radius: 9999px;
        }
        .match-mode-toggle .match-mode-button:last-child {
            border-top-right-radius: 9999px;
            border-bottom-right-radius: 9999px;
        }
    </style>
    
    <script type="text/javascript">
        // Global Variables
        let players = {}; // Map to store players: { id: { id, name, elo, top1Since, ... } }
        let isAdmin = false;
        let confirmationCallback = null; // Global variable for confirmation callback
        let firebaseReady = false; // Indicates if Auth and Firestore are initialized
        let matchMode = 'WIN_LOSS'; // NOUVEAU: 'WIN_LOSS' ou 'DRAW' pour la bascule
        
        // Firebase Instances
        let db;
        let auth;
        let userId = 'unknown';

        // State pour l'affichage des d√©tails mobiles (pour impl√©menter l'accordion)
        let openDetailRowId = null; // Stocke l'ID du joueur dont la ligne de d√©tail est ouverte
        
        // Constants
        const INITIAL_ELO = 500; // Elo initial pour les nouveaux joueurs
        const K_FACTOR_WIN = 75; // Facteur K pour une victoire standard
        const K_FACTOR_DRAW = 10; // Facteur K pour le joueur le plus faible lors d'un match nul (selon la r√®gle sp√©ciale)
        const ADMIN_PASSWORD = "techno"; // Mot de passe admin
        // --- MODIFICATION: URL de l'application Google Apps Script pour l'historique ---
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz9V5JR0lI6-VQXbht0JVdyTi1aa6eHQtCof193WNk8O1A3Q-Nj5K4SU2ypVI9VoM7e/exec"; // REMPLACER CECI
        // ---------------------------------------------------------------------------------

        // Codes de couleur des m√©dailles
        const MEDAL_COLORS = {
            1: '#F5E727', // Or
            2: '#C0C0C0', // Argent
            3: '#CD7F32', // Bronze
        };
        const MEDAL_TEXT_COLOR = {
            1: 'text-on-light', // Dark text on Gold
            2: 'text-on-light', // Dark text on Silver
            3: 'text-on-bronze', // White text on Bronze
        };


        // --- Configuration Firebase (Int√©gr√©e avec vos cl√©s !) ---

        /**
         * Returns the collection path for the Elo players.
         */
        function getCollectionPath() {
            // Revenir au chemin simple car l'environnement Canvas est stable
            return `elo_players`; 
        }
        
        // Configuration Firebase (PLACEHOLDER: REMPLACEZ PAR VOTRE VRAIE CONFIG)
        const firebaseConfig = {
            apiKey: "AIzaSyDWBh3YC57FSEzzd66JhDNwgLn0S9POVtc",
            authDomain: "classement-elo.firebaseapp.com",
            projectId: "classement-elo",
            storageBucket: "classement-elo.firebasestorage.app",
            messagingSenderId: "240751765604",
            appId: "1:240751765604:web:bfc2d16d768cede61b99971",
            measurementId: "G-FREKR0HFH"
        };
        const initialAuthToken = null; // Pas de jeton inject√© dans un d√©ploiement GitHub

        // --- Firebase Initialization and Data Sync ---

        /**
         * Initializes Firebase, performs authentication, and sets up the data listener.
         */
        async function initializeFirebase() {
            const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, getFirestore, onAuthStateChanged, setLogLevel } = window.firebase;

            if (!firebaseConfig || !firebaseConfig.apiKey) {
                document.getElementById('loading-message').textContent = "Erreur: Configurez vos cl√©s Firebase dans le code !";
                return;
            }

            try {
                // Initialisation des services
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // setLogLevel('Debug'); 

                document.getElementById('loading-message').textContent = "Connexion √† Firebase...";

                // 1. Authentification
                let authPromise;
                if (initialAuthToken) {
                    // Tentative d'utilisation du jeton fourni par Canvas
                    authPromise = signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Sinon, connexion anonyme pour obtenir un userId
                    authPromise = signInAnonymously(auth);
                }
                await authPromise;
                
                // √âcoute des changements d'√©tat d'authentification
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Utilisateur authentifi√©. UID:", userId);
                        
                        // 2. Synchronisation des donn√©es (apr√®s l'authentification)
                        if (!firebaseReady) {
                            setupFirestoreListener();
                            firebaseReady = true;
                            document.getElementById('loading-spinner').classList.add('hidden');
                        }
                    } else {
                        console.log("Utilisateur d√©connect√© (anonyme ou autre).");
                    }
                });

            } catch (error) {
                console.error("Erreur d'initialisation Firebase ou d'authentification:", error);
                document.getElementById('loading-message').textContent = `Erreur de connexion Firebase: ${error.message}`;
            }
        }

        /**
         * Sets up the real-time listener for the players collection.
         */
        function setupFirestoreListener() {
            const { collection, query, onSnapshot } = window.firebase;
            
            const playersCollectionRef = collection(db, getCollectionPath());
            const q = query(playersCollectionRef);

            // √âcoute en temps r√©el des changements
            onSnapshot(q, (snapshot) => {
                const updatedPlayers = {};
                snapshot.forEach((doc) => {
                    updatedPlayers[doc.id] = { 
                        id: doc.id, 
                        top1Since: null, 
                        wins: 0, 
                        losses: 0,
                        matches: 0,
                        elo: INITIAL_ELO,
                        ...doc.data() 
                    };
                });
                players = updatedPlayers;
                
                const sortedPlayers = getSortedRanking(players);
                console.log("Donn√©es de classement synchronis√©es en temps r√©el.");
                
                manageTop1Streak(sortedPlayers); 
                
                renderAll(); // <--- Rendu complet apr√®s chaque synchronisation des donn√©es
            }, (error) => {
                console.error("Erreur d'√©coute Firestore:", error);
                document.getElementById('match-message').textContent = "Erreur de synchronisation des donn√©es.";
                document.getElementById('match-message').className = "text-red-600 font-medium ui-message";
            });
        }
        
        /**
         * Manages the top1Since field for players to track the streak duration.
         */
        async function manageTop1Streak(sortedPlayers) {
            if (!firebaseReady || sortedPlayers.length === 0 || !db) return;
            
            const { setDoc, doc } = window.firebase;
            
            const newTopPlayer = sortedPlayers[0];
            const newTopId = newTopPlayer.id;

            let oldTopIdWithStamp = null;
            for (const id in players) {
                if (players[id].top1Since) {
                    oldTopIdWithStamp = id;
                    break;
                }
            }
            
            if (newTopId !== oldTopIdWithStamp) {
                
                console.log(`Changement de Rank 1 d√©tect√©: ${oldTopIdWithStamp || 'N/A'} -> ${newTopId}`);
                
                // A) R√©initialiser l'ancien Top 1 (s'il existe)
                if (oldTopIdWithStamp && players[oldTopIdWithStamp].top1Since) {
                     const oldRef = doc(db, getCollectionPath(), oldTopIdWithStamp);
                     try {
                        await setDoc(oldRef, { top1Since: null }, { merge: true });
                     } catch (e) {
                        console.error("√âchec de la r√©initialisation de l'ancien top1Since:", e);
                     }
                }

                // B) D√©finir le timestamp pour le nouveau Top 1
                const newRef = doc(db, getCollectionPath(), newTopId);
                try {
                    await setDoc(newRef, { top1Since: new Date().getTime() }, { merge: true });
                } catch (e) {
                    console.error("√âchec de la d√©finition du nouveau top1Since:", e);
                }

            } else if (!newTopPlayer.top1Since) {
                 // Cas sp√©cial: Le Top 1 est le m√™me, mais le timestamp n'√©tait pas d√©fini (ex: premi√®re initialisation)
                 const newRef = doc(db, getCollectionPath(), newTopId);
                 try {
                     await setDoc(newRef, { top1Since: new Date().getTime() }, { merge: true });
                 } catch (e) {
                    console.error("√âchec de la d√©finition initiale de top1Since:", e);
                 }
            }
        }


        // --- Elo Calculation & Utilities ---

        /**
         * Calculates the expected score of Player A against Player B.
         */
        function calculateExpectedScore(Ra, Rb) {
            return 1 / (1 + Math.pow(10, (Rb - Ra) / 400));
        }

        /**
         * Calculates the new Elo rating for a single player.
         * @param {number} R_current - Current Elo of the player.
         * @param {number} R_opponent - Elo of the opponent.
         * @param {number} S - Score achieved (1 for win, 0 for loss).
         * @param {number} K - K-factor.
         * @returns {number} The new Elo rating.
         */
        function calculateNewElo(R_current, R_opponent, S, K) {
            const E = calculateExpectedScore(R_current, R_opponent);
            const newR = R_current + K * (S - E);
            return Math.round(newR);
        }

        /**
         * Converts player map to a sorted array for ranking, adding win percentage.
         */
        function getSortedRanking(playerMap) {
            return Object.values(playerMap)
                .map(p => {
                    const totalWL = p.wins + p.losses;
                    
                    // Calcul du pourcentage de victoires bas√© sur Wins / (Wins + Losses)
                    const winRate = totalWL > 0 && p.wins !== undefined
                        ? ((p.wins / totalWL) * 100).toFixed(1)
                        : '0.0';
                        
                    return {
                        ...p,
                        // S'assurer que top1Since est bien un nombre ou null
                        top1Since: p.top1Since && typeof p.top1Since === 'number' ? p.top1Since : null, 
                        // Taux de victoire calcul√© selon la nouvelle r√®gle
                        winRate: winRate,
                        // Ajouter le nombre de jours pour la streak
                        top1Days: p.top1Since ? Math.floor((new Date().getTime() - p.top1Since) / (1000 * 60 * 60 * 24)) : 0
                    };
                })
                .sort((a, b) => b.elo - a.elo || a.name.localeCompare(b.name))
                .map((p, index) => ({
                    ...p,
                    rank: index + 1
                }));
        }

        /**
         * Toggles the visibility of the detail row for a given player ID, 
         * ensuring only one row is open at a time (accordion behavior).
         */
        window.toggleDetails = function(playerId) {
            const detailRow = document.getElementById(`detail-row-${playerId}`);
            const button = document.getElementById(`detail-button-${playerId}`);
            
            if (!detailRow || !button) return;

            const isClosingCurrent = openDetailRowId === playerId;

            if (openDetailRowId && openDetailRowId !== playerId) {
                const prevDetailRow = document.getElementById(`detail-row-${openDetailRowId}`);
                const prevButton = document.getElementById(`detail-button-${openDetailRowId}`);
                
                if (prevDetailRow) {
                    prevDetailRow.classList.add('hidden');
                }
                if (prevButton) {
                    prevButton.querySelector('svg').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>';
                }
            }

            if (isClosingCurrent) {
                detailRow.classList.add('hidden');
                button.querySelector('svg').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>';
                openDetailRowId = null;
            } else {
                detailRow.classList.remove('hidden');
                button.querySelector('svg').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>';
                openDetailRowId = playerId;
            }
        }


        // --- UI Rendering ---

        /**
         * Renders the main ranking table.
         */
        function renderRanking() {
            const rankingList = document.getElementById('ranking-list');
            if (!rankingList) return;

            const sortedPlayers = getSortedRanking(players);
            const isAdminMode = isAdmin;

            if (Object.keys(players).length === 0) {
                rankingList.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun joueur dans le classement pour le moment. Connectez-vous en Admin pour en ajouter.</p>';
                return;
            }

            rankingList.innerHTML = `
                <div class="mb-6"> 
                    <table class="min-w-full divide-y divide-gray-200 shadow-xl rounded-lg overflow-hidden">
                        <thead class="bg-primary/90 text-white">
                            <tr>
                                <th class="px-2 sm:px-6 py-3 text-left text-xs font-bold uppercase tracking-wider"># Rank</th>
                                <th class="px-2 sm:px-6 py-3 text-left text-xs font-bold uppercase tracking-wider">Nom du Joueur</th>
                                <th class="px-2 sm:px-6 py-3 text-right text-xs font-bold uppercase tracking-wider">Elo</th>
                                <th class="px-6 py-3 text-right text-xs font-bold uppercase tracking-wider hidden sm:table-cell">Win %</th>
                                <th class="px-6 py-3 text-right text-xs font-bold uppercase tracking-wider hidden sm:table-cell">Parties Jou√©es</th>
                                <th class="px-2 py-3 text-center text-xs font-bold uppercase tracking-wider sm:hidden">...</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            ${sortedPlayers.map(p => {
                                const isDetailOpen = openDetailRowId === p.id;
                                
                                let rowColor = MEDAL_COLORS[p.rank] || '';
                                let textColorClass = MEDAL_TEXT_COLOR[p.rank] || 'text-gray-900';
                                
                                const rowClass = rowColor ? `shadow-inner transform hover:scale-[1.01] transition duration-150 ease-in-out` : `bg-white hover:bg-indigo-50 transition duration-150 ease-in-out`;
                                const rowStyle = rowColor ? `style="background-color: ${rowColor};"` : '';
                                
                                return `
                                    <!-- Ligne Principale -->
                                    <tr class="${rowClass}" ${rowStyle}>
                                        <td class="px-2 sm:px-6 py-4 whitespace-nowrap text-sm font-medium ${textColorClass}">
                                            <span class="font-bold">${p.rank === 1 ? 'ü•á' : p.rank === 2 ? 'ü•à' : p.rank === 3 ? 'ü•â' : p.rank}</span>
                                        </td>
                                        <td class="px-2 sm:px-6 py-4 whitespace-nowrap text-sm ${textColorClass}">${p.name}</td>
                                        <td class="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-right font-bold ${textColorClass}">${p.elo}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium ${p.winRate >= 50 ? 'text-secondary' : 'text-yellow-800'} hidden sm:table-cell">${p.winRate}%</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right ${textColorClass} hidden sm:table-cell">${p.matches}</td>
                                        
                                        <!-- Bouton D√©tails pour Mobile -->
                                        <td class="px-2 py-4 text-center sm:hidden">
                                            <button id="detail-button-${p.id}" onclick="toggleDetails('${p.id}')" 
                                                    class="p-1 rounded-full text-primary hover:bg-primary/10 transition duration-150">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    ${isDetailOpen 
                                                        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>'
                                                        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>'}
                                                </svg>
                                            </button>
                                        </td>
                                    </tr>
                                    
                                    <!-- Ligne de D√©tails -->
                                    <tr id="detail-row-${p.id}" class="detail-row ${isDetailOpen ? '' : 'hidden'} sm:hidden">
                                        <td colspan="4" class="p-4 bg-gray-50 border-t border-gray-200">
                                            <div class="text-xs space-y-1 ${textColorClass}">
                                                ${p.rank === 1 && p.top1Since ? `
                                                    <div class="flex justify-between font-semibold text-primary">
                                                        <span>S√©rie Top 1 en cours :</span>
                                                        <span>${p.top1Days} jours</span>
                                                    </div>
                                                ` : ''}
                                                <div class="flex justify-between font-semibold">
                                                    <span>Victoires / D√©faites :</span>
                                                    <span>${p.wins} W / ${p.losses} L</span>
                                                </div>
                                                <div class="flex justify-between font-semibold">
                                                    <span>Parties Jou√©es :</span>
                                                    <span>${p.matches}</span>
                                                </div>
                                                <div class="flex justify-between font-semibold">
                                                    <span>Taux de Victoire (W/L) :</span>
                                                    <span class="${p.winRate >= 50 ? 'text-secondary' : 'text-yellow-800'}">${p.winRate}%</span>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                ${isAdminMode ? `
                    <div class="flex justify-center mt-6">
                        <button onclick="downloadRankingPdf()" 
                                class="px-6 py-2 bg-indigo-500 text-white text-sm font-medium rounded-md hover:bg-indigo-600 transition duration-150 shadow-md flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H5a2 2 0 01-2-2v-4c0-1.1.9-2 2-2h14a2 2 0 012 2v4c0 1.1-.9 2-2 2z"></path></svg>
                            T√©l√©charger en PDF
                        </button>
                    </div>
                ` : ''}
            `;
        }

        /**
         * Change le mode d'enregistrement de match et re-render le formulaire.
         */
        window.setMatchMode = function(mode) {
            matchMode = mode;
            renderMatchRecorder();
        }

        /**
         * Renders the match recording form in Admin mode based on the current mode.
         */
        function renderMatchRecorder() {
            const matchRecorder = document.getElementById('match-recorder');
            const sortedPlayers = getSortedRanking(players);

            if (sortedPlayers.length < 2) {
                matchRecorder.innerHTML = '<p class="text-sm text-yellow-600">Ajoutez au moins deux joueurs pour enregistrer un match.</p>';
                return;
            }

            const defaultOption = '<option value="" disabled selected>-- S√©lectionner --</option>';
            const playerOptions = sortedPlayers.map(p => 
                `<option value="${p.id}">${p.name}</option>`
            ).join('');
            const optionsHtml = defaultOption + playerOptions;

            let title, label1, label2, buttonText, buttonClass;
            
            // Logique d'affichage en fonction du mode (WIN_LOSS ou DRAW)
            if (matchMode === 'WIN_LOSS') {
                title = "Enregistrer une Victoire / D√©faite";
                label1 = "Gagnant :";
                label2 = "Perdant :";
                buttonText = "Enregistrer la Victoire";
                buttonClass = "bg-secondary hover:bg-emerald-600 focus:ring-secondary";
            } else { // DRAW mode
                title = "Enregistrer un Match Nul Sp√©cial";
                label1 = "Joueur A :";
                label2 = "Joueur B :";
                buttonText = "Enregistrer le Match Nul";
                buttonClass = "bg-yellow-600 hover:bg-yellow-700 focus:ring-yellow-500";
            }

            matchRecorder.innerHTML = `
                <h3 class="text-xl font-semibold mb-4 text-primary text-center">${title}</h3>
                
                <!-- Bascule du Mode -->
                <div class="match-mode-toggle mb-6">
                    <button id="mode-winloss" 
                            onclick="setMatchMode('WIN_LOSS')" 
                            class="match-mode-button ${matchMode === 'WIN_LOSS' ? 'active' : ''}">
                        Victoire / D√©faite
                    </button>
                    <button id="mode-draw" 
                            onclick="setMatchMode('DRAW')" 
                            class="match-mode-button ${matchMode === 'DRAW' ? 'active' : ''}">
                        Match Nul
                    </button>
                </div>
                
                <div class="space-y-4">
                    
                    <!-- S√©lection des Joueurs -->
                    <div class="flex flex-col md:flex-row md:space-x-4 space-y-4 md:space-y-0">
                        
                        <!-- Section Joueur 1 (Gagnant / Joueur A) -->
                        <div class="md:w-1/2">
                            <label for="player-one-select" class="block text-sm font-medium text-gray-700">${label1}</label>
                            <select id="player-one-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm rounded-md shadow-sm">
                                ${optionsHtml}
                            </select>
                        </div>
                        
                        <!-- Section Joueur 2 (Perdant / Joueur B) -->
                        <div class="md:w-1/2">
                            <label for="player-two-select" class="block text-sm font-medium text-gray-700">${label2}</label>
                            <select id="player-two-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm rounded-md shadow-sm">
                                ${optionsHtml}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Bouton d'Action -->
                    <button id="record-match-btn" 
                            onclick="recordMatch()" 
                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white ${buttonClass} focus:outline-none focus:ring-2 focus:ring-offset-2 transition duration-150">
                        ${buttonText}
                    </button>
                    <div id="match-message" class="text-sm text-center ui-message"></div>
                </div>
            `;
        }

        /**
         * Handles the recording of a match result and updates player Elo using a transaction.
         * LOGIQUE MISE √Ä JOUR POUR G√âRER matchMode='DRAW' SANS AUGMENTER WINS/LOSSES.
         */
        window.recordMatch = async function() {
            if (!isAdmin || !firebaseReady) return;
            
            const playerOneId = document.getElementById('player-one-select').value;
            const playerTwoId = document.getElementById('player-two-select').value;

            if (!playerOneId || !playerTwoId) {
                showUIMessage('match-message', "Veuillez s√©lectionner les deux joueurs.", false);
                return;
            }

            if (playerOneId === playerTwoId) {
                showUIMessage('match-message', "Les joueurs doivent √™tre diff√©rents.", false);
                return;
            }
            
            let winnerId, loserId, K;
            let currentWinnerElo, currentLoserElo;
            
            const pA = players[playerOneId];
            const pB = players[playerTwoId];
            
            if (matchMode === 'WIN_LOSS') {
                // Mode Victoire/D√©faite (Win/Loss)
                K = K_FACTOR_WIN;
                winnerId = playerOneId; // Player One est le Gagnant
                loserId = playerTwoId;  // Player Two est le Perdant
                
            } else { // matchMode === 'DRAW'
                // Mode Match Nul (Draw) - Logique Elo sp√©ciale
                
                // NOUVEAU: V√©rifier si les Elos sont √©gaux
                if (pA.elo === pB.elo) {
                    // Elos √©gaux, pas de changement d'Elo, seulement l'incr√©ment de 'matches'
                    
                    // Incr√©menter les 'matches' pour les deux joueurs
                    try {
                        const { runTransaction, doc } = window.firebase;
                        await runTransaction(db, async (transaction) => {
                            const pARef = doc(db, getCollectionPath(), pA.id);
                            const pBRef = doc(db, getCollectionPath(), pB.id);
                            
                            const pASnapshot = await transaction.get(pARef);
                            const pBSnapshot = await transaction.get(pBRef);

                            if (!pASnapshot.exists() || !pBSnapshot.exists()) {
                                throw "Les documents du joueur n'existent pas ou ont √©t√© supprim√©s.";
                            }
                            
                            // Mise √† jour de 'matches' seulement
                            transaction.set(pARef, { matches: (pASnapshot.data().matches || 0) + 1 }, { merge: true });
                            transaction.set(pBRef, { matches: (pBSnapshot.data().matches || 0) + 1 }, { merge: true });
                        });
                        
                        // Message de succ√®s sans changement d'Elo
                        showUIMessage('match-message', `Match Nul Enregistr√©! Elos √©gaux, pas de changement de score. Parties Jou√©es incr√©ment√©es.`);
                        return; // Sortir apr√®s l'incr√©ment de 'matches'
                        
                    } catch (e) {
                        console.error("Erreur lors de l'enregistrement du match nul (Transaction √©chou√©e): ", e);
                        showUIMessage('match-message', `Erreur lors de l'enregistrement du match : V√©rifiez la console.`, false);
                        return;
                    }
                }
                
                // Si Elos diff√©rents, continuer avec le calcul Elo normal
                
                // 1. D√©terminer qui a l'Elo le plus bas (Gagnant conceptuel pour le K-factor sp√©cial)
                K = K_FACTOR_DRAW;
                
                if (pA.elo < pB.elo) {
                    winnerId = pA.id;
                    loserId = pB.id;
                } else { 
                    // Si pB.elo < pA.elo (la condition d'√©galit√© a √©t√© g√©r√©e ci-dessus)
                    winnerId = pB.id;
                    loserId = pA.id;
                } 
                // Note: La r√®gle du K-Factor sp√©cial ne change pas : le joueur le plus faible gagne un peu d'Elo.
            }
            
            // Les donn√©es ici sont bas√©es sur le r√¥le conceptuel (winner gagne points, loser en perd)
            const winnerData = players[winnerId]; 
            const loserData = players[loserId]; 
            
            try {
                const { runTransaction, doc } = window.firebase;
                let eloChangeWinner, eloChangeLoser;
                let newWinnerElo, newLoserElo;

                await runTransaction(db, async (transaction) => {
                    // 2. Lire les documents les plus r√©cents dans la transaction
                    const winnerRef = doc(db, getCollectionPath(), winnerId);
                    const loserRef = doc(db, getCollectionPath(), loserId);
                    
                    const winnerSnapshot = await transaction.get(winnerRef);
                    const loserSnapshot = await transaction.get(loserRef);

                    if (!winnerSnapshot.exists() || !loserSnapshot.exists()) {
                        throw "Les documents du joueur n'existent pas ou ont √©t√© supprim√©s.";
                    }

                    currentWinnerElo = winnerSnapshot.data().elo;
                    currentLoserElo = loserSnapshot.data().elo;
                    
                    // 3. Calculer les nouveaux Elos (Score S=1 pour le "gagnant", S=0 pour le "perdant")
                    // NOTE: La logique Elo standard est conserv√©e, mais avec le K sp√©cial pour le DRAW.
                    newWinnerElo = calculateNewElo(currentWinnerElo, currentLoserElo, 1, K);
                    newLoserElo = calculateNewElo(currentLoserElo, currentWinnerElo, 0, K);

                    eloChangeWinner = newWinnerElo - currentWinnerElo;
                    eloChangeLoser = newLoserElo - currentLoserElo;

                    // 4. Mettre √† jour les donn√©es
                    if (matchMode === 'WIN_LOSS') {
                        // Mise √† jour pour une Victoire/D√©faite classique
                         transaction.set(winnerRef, { 
                            elo: newWinnerElo, 
                            wins: (winnerSnapshot.data().wins || 0) + 1, 
                            matches: (winnerSnapshot.data().matches || 0) + 1 
                        }, { merge: true });
                        
                        transaction.set(loserRef, { 
                            elo: newLoserElo, 
                            losses: (loserSnapshot.data().losses || 0) + 1, 
                            matches: (loserSnapshot.data().matches || 0) + 1 
                        }, { merge: true });
                    } else { // matchMode === 'DRAW' (Elos diff√©rents seulement)
                        // Mise √† jour pour un Match Nul: Elo change mais SEULEMENT 'matches' augmente
                        
                        // Joueur 1 (Gagnant conceptuel pour l'Elo, mais pas de 'win' officiel)
                        transaction.set(winnerRef, { 
                            elo: newWinnerElo, 
                            matches: (winnerSnapshot.data().matches || 0) + 1 
                        }, { merge: true });
                        
                        // Joueur 2 (Perdant conceptuel pour l'Elo, mais pas de 'loss' officiel)
                        transaction.set(loserRef, { 
                            elo: newLoserElo, 
                            matches: (loserSnapshot.data().matches || 0) + 1 
                        }, { merge: true });
                    }
                });
                
                // Si la transaction r√©ussit, afficher le message
                let successMessage;
                if (matchMode === 'DRAW') {
                    // Message neutre pour l'utilisateur
                    const pA_name = players[playerOneId].name;
                    const pB_name = players[playerTwoId].name;
                    
                    // Utiliser les Elos finaux calcul√©s pour d√©terminer le changement pour chaque joueur
                    const pA_change = playerOneId === winnerId ? eloChangeWinner : eloChangeLoser;
                    const pB_change = playerTwoId === winnerId ? eloChangeWinner : eloChangeLoser;

                    successMessage = `Match Nul Enregistr√©! ${pA_name} change de ${pA_change > 0 ? '+' : ''}${pA_change} Elo. ${pB_name} change de ${pB_change > 0 ? '+' : ''}${pB_change} Elo. (Match jou√© comptabilis√© pour les deux)`;

                } else {
                    successMessage = `Victoire! ${winnerData.name} gagne (${currentWinnerElo} -> ${newWinnerElo}, +${eloChangeWinner}) contre ${loserData.name} (${currentLoserElo} -> ${newLoserElo}, ${eloChangeLoser}).`;
                }
                showUIMessage('match-message', successMessage);
                
                // --- AJOUT: Enregistrer l'historique dans Google Sheet (utilise les joueurs conceptuels) ---
                logMatchToSheet({
                    winnerId: winnerId,
                    loserId: loserId,
                    winnerName: winnerData.name,
                    loserName: loserData.name,
                    newWinnerElo: newWinnerElo,
                    newLoserElo: newLoserElo,
                    eloChangeWinner: eloChangeWinner,
                    eloChangeLoser: eloChangeLoser
                });
                // --------------------------------------------------------

            } catch (e) {
                console.error("Erreur lors de l'enregistrement du match (Transaction √©chou√©e): ", e);
                showUIMessage('match-message', `Erreur lors de l'enregistrement du match : V√©rifiez la console.`, false);
            }
        }

        // --- Autres fonctions (inchang√©es) ---
        
        /**
         * Generates and downloads a PDF of the current ranking table.
         */
        window.downloadRankingPdf = function() {
            // Acc√®s s√©curis√© au constructeur jsPDF (commun pour l'import UMD)
            const jsPDFConstructor = window.jspdf && window.jspdf.jsPDF ? window.jspdf.jsPDF : window.jsPDF;

            if (typeof jsPDFConstructor === 'undefined') {
                showUIMessage('match-message', 'Erreur: La librairie jsPDF est introuvable.', false);
                return;
            }
            
            const doc = new jsPDFConstructor('p', 'mm', 'a4'); // 'p' for portrait, 'mm' for units, 'a4' for size

            if (typeof doc.autoTable !== 'function') {
                showUIMessage('match-message', 'Erreur: Le plugin jspdf-autotable est introuvable. (V√©rifiez l\'import)', false);
                return;
            }

            const sortedPlayers = getSortedRanking(players);
            const date = new Date().toLocaleDateString('fr-FR');
            const primaryColor = [79, 70, 229]; // Tailwind Indigo 600
            
            // Pr√©paration des donn√©es pour autotable
            const head = [['# Rank / Streak', 'Nom du Joueur', 'Elo', 'Win %', 'Parties Jou√©es']];
            const body = sortedPlayers.map(p => {
                const streakText = p.rank === 1 && p.top1Since ? 
                                 ` (Depuis ${p.top1Days} j)` : '';
                return [
                    `${p.rank}${streakText}`,
                    p.name,
                    p.elo,
                    `${p.winRate}%`,
                    p.matches
                ];
            });

            // Ajout du titre
            doc.setFontSize(14);
            doc.text("Classement JD Elo - " + date, 14, 15);
            doc.setFontSize(10);
            
            // G√©n√©ration du tableau
            doc.autoTable({
                startY: 20, 
                head: head,
                body: body,
                theme: 'striped',
                headStyles: { 
                    fillColor: primaryColor, 
                    textColor: 255, 
                    fontStyle: 'bold',
                    fontSize: 9,
                    valign: 'middle'
                },
                styles: { 
                    font: 'helvetica', 
                    cellPadding: 2, 
                    fontSize: 10,
                    lineWidth: 0.1, 
                    lineColor: [200, 200, 200]
                },
                bodyStyles: {
                    textColor: [30, 30, 30] 
                },
                columnStyles: { 
                    0: { cellWidth: 35, halign: 'right' }, 
                    1: { halign: 'left' },                 
                    2: { halign: 'right' },                
                    3: { halign: 'right' },                
                    4: { halign: 'right' }                 
                },
                didDrawCell: (data) => {
                    if (data.section === 'body') {
                        const rank = data.row.index + 1;
                        let fillColor = null;
                        
                        if (rank === 1) fillColor = '#F5E727';
                        else if (rank === 2) fillColor = '#C0C0C0';
                        else if (rank === 3) fillColor = '#CD7F32';

                        if (fillColor) {
                            doc.setFillColor(fillColor);
                            doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                            
                            const textColor = (rank === 1 || rank === 2) ? '#1f2937' : '#f9fafb'; 
                            doc.setTextColor(textColor);
                            
                            const text = data.cell.text;
                            let x = data.cell.x + data.cell.padding('left'); 
                            const y = data.cell.y + data.cell.height / 2;
                            let align = 'left';

                            if (data.column.index !== 1) { 
                                x = data.cell.x + data.cell.width - data.cell.padding('right');
                                align = 'right';
                            }
                            
                            doc.text(text, x, y, { baseline: 'middle', align: align });
                            
                            data.cell.text = '';
                        }
                    }
                }
            });

            doc.save(`Classement_JD_Elo_${date}.pdf`);
        };


        /**
         * Met √† jour la visibilit√© des √©l√©ments de l'interface Admin (boutons, containers).
         */
        function updateAdminUiVisibility() {
            const adminLogin = document.getElementById('admin-login-container');
            const matchRecorderContainer = document.getElementById('match-recorder-container'); 
            const adminPencil = document.getElementById('admin-pencil');
            const dbStatus = document.getElementById('db-status');

            dbStatus.classList.remove('hidden');

            if (isAdmin) {
                adminLogin.classList.add('hidden');
                matchRecorderContainer.classList.remove('hidden'); 
                adminPencil.classList.remove('hidden');
                dbStatus.className = "bg-primary text-white text-xs font-medium px-2.5 py-0.5 rounded-full";
                dbStatus.textContent = "‚òÅÔ∏è Mode Admin (Connect√©)";
            } else {
                adminLogin.classList.remove('hidden');
                matchRecorderContainer.classList.add('hidden'); 
                adminPencil.classList.add('hidden');
                dbStatus.className = "bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full";
                dbStatus.textContent = "‚òÅÔ∏è Lecture Seule";
            }
        }

        /**
         * Renders the player management modal content.
         */
        function renderPlayerManager() {
            const playerListContainer = document.getElementById('player-list-container');
            const sortedPlayers = getSortedRanking(players);

            // Populate current players for rename/remove
            playerListContainer.innerHTML = sortedPlayers.map(p => `
                <li class="flex items-center justify-between py-2 border-b border-gray-100">
                    <span class="text-gray-700">${p.name} (Elo: ${p.elo}, W: ${p.wins}, L: ${p.losses}, P: ${p.matches})</span>
                    <div class="space-x-2">
                        <button onclick="
                                document.getElementById('rename-player-id').value='${p.id}'; 
                                document.getElementById('rename-player-name').value='${p.name}'; 
                                document.getElementById('new-elo-score').value='${p.elo}';
                                document.getElementById('new-wins').value='${p.wins}'; 
                                document.getElementById('new-losses').value='${p.losses}'; 
                                document.getElementById('new-matches').value='${p.matches}'; 
                                toggleRenameModal(true);"
                                class="text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-100 transition duration-150" title="Renommer / Modifier Stats">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        </button>
                        <button onclick="confirmRemovePlayer('${p.id}', '${p.name}')"
                                class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition duration-150" title="Supprimer">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </li>
            `).join('') || '<p class="text-gray-500">Aucun joueur √† g√©rer.</p>';
        }

        /**
         * Renders all dynamic parts of the UI.
         */
        function renderAll() {
             updateAdminUiVisibility(); 
             renderRanking();          
             renderMatchRecorder();     
             renderPlayerManager();     
        }

        /**
         * Utility function to display success/error messages in the UI.
         */
        function showUIMessage(elementId, message, isSuccess = true) {
            const messageElement = document.getElementById(elementId);
            if (!messageElement) return;

            messageElement.textContent = message;
            messageElement.className = `text-sm text-center ui-message ${isSuccess ? 'text-green-600' : 'text-red-600'} font-medium`;
            
            setTimeout(() => {
                messageElement.classList.add('fade-out');
                setTimeout(() => {
                    messageElement.textContent = '';
                    messageElement.classList.remove('fade-out');
                }, 500); 
            }, 5000);
        }

        // --- Modal Handling ---

        /**
         * Toggles the visibility of any modal.
         */
        function toggleModal(modalId, show) {
            const modal = document.getElementById(modalId);
            if (modal) {
                if (show) {
                    modal.classList.remove('hidden');
                } else {
                    modal.classList.add('hidden');
                }
            }
        }
        
        /**
         * Shows the generic confirmation modal.
         */
        function showConfirmationModal(message, callback) {
            confirmationCallback = callback;
            document.getElementById('confirmation-message').textContent = message;
            toggleModal('confirmation-modal', true);
        }

        // Expose functions to global scope for HTML event handlers (onclick)
        window.togglePlayerManagementModal = (show) => toggleModal('player-management-modal', show);
        window.toggleRenameModal = (show) => toggleModal('rename-modal', show);
        window.toggleAdminLoginModal = (show) => toggleModal('admin-login-modal', show);
        
        /**
         * Executes the confirmation callback if confirmed and hides the modal.
         */
        window.confirmAction = (confirmed) => {
            toggleModal('confirmation-modal', false);
            if (confirmed && confirmationCallback) {
                confirmationCallback();
            }
            confirmationCallback = null;
        }


        // --- Admin Actions (unchanged) ---

        /**
         * Handles the Admin Login process.
         */
        window.handleAdminLogin = function() {
            const passwordInput = document.getElementById('admin-password');
            const password = passwordInput.value;
            const messageElement = document.getElementById('admin-login-message');

            if (password === ADMIN_PASSWORD) {
                isAdmin = true;
                messageElement.textContent = "Mode Administrateur activ√©.";
                messageElement.className = "text-green-600 text-sm";
                passwordInput.value = '';
                toggleModal('admin-login-modal', false);
                renderAll(); 
            } else {
                isAdmin = false;
                messageElement.textContent = "Mot de passe incorrect.";
                messageElement.className = "text-red-600 text-sm";
            }
        }

        /**
         * Adds a new player to Firestore.
         */
        window.addPlayer = async function() {
            if (!isAdmin || !firebaseReady) return;
            
            const playerNameInput = document.getElementById('new-player-name');
            const playerName = playerNameInput.value.trim();
            const messageElement = document.getElementById('player-management-message');

            if (!playerName) {
                showUIMessage('player-management-message', "Veuillez entrer un nom de joueur.", false);
                return;
            }

            if (Object.values(players).some(p => p.name.toLowerCase() === playerName.toLowerCase())) {
                showUIMessage('player-management-message', "Ce joueur existe d√©j√†.", false);
                return;
            }

            try {
                const { setDoc, doc, collection } = window.firebase;
                const newPlayerRef = doc(collection(db, getCollectionPath())); 
                const newPlayer = {
                    name: playerName,
                    elo: INITIAL_ELO,
                    wins: 0,
                    losses: 0,
                    matches: 0,
                    createdAt: new Date().getTime(),
                    top1Since: null, 
                    createdBy: userId 
                };
                
                await setDoc(newPlayerRef, newPlayer);

                playerNameInput.value = '';
                showUIMessage('player-management-message', `Joueur '${playerName}' ajout√© avec succ√®s!`);
            } catch (error) {
                console.error("Erreur lors de l'ajout du joueur:", error);
                showUIMessage('player-management-message', "Erreur: √âchec de l'ajout du joueur (v√©rifiez les r√®gles Firestore).", false);
            }
        }

        /**
         * Prompts and handles player removal confirmation using the custom modal.
         */
        window.confirmRemovePlayer = (playerId, playerName) => {
            showConfirmationModal(
                `√ätes-vous s√ªr de vouloir supprimer le joueur '${playerName}'? Cette action est irr√©versible.`,
                () => removePlayer(playerId)
            );
        };


        /**
         * Removes a player from Firestore.
         */
        async function removePlayer(playerId) {
            if (!isAdmin || !firebaseReady) return;
            
            try {
                const { deleteDoc, doc } = window.firebase;
                await deleteDoc(doc(db, getCollectionPath(), playerId));
                
                showUIMessage('player-management-message', "Joueur supprim√© avec succ√®s!");
            } catch (error) {
                 console.error("Erreur lors de la suppression du joueur:", error);
                 showUIMessage('player-management-message', "Erreur: √âchec de la suppression du joueur.", false);
            }
        }

        /**
         * Renames a player and/or changes their Elo/Stats in Firestore.
         */
        window.updatePlayerDetails = async function() {
            if (!isAdmin || !firebaseReady) return;
            
            const playerId = document.getElementById('rename-player-id').value;
            const newName = document.getElementById('rename-player-name').value.trim();
            const newEloValue = document.getElementById('new-elo-score').value.trim();
            const newWinsValue = document.getElementById('new-wins').value.trim();
            const newLossesValue = document.getElementById('new-losses').value.trim();
            // NOUVEAU: R√©cup√©rer la valeur du champ "Matches"
            const newMatchesValue = document.getElementById('new-matches').value.trim(); 
            const messageElement = document.getElementById('rename-modal-message');

            const currentPlayer = players[playerId];
            if (!currentPlayer) {
                 showUIMessage('rename-modal-message', "Erreur: Joueur introuvable pour la modification.", false);
                 return;
            }
            
            let updateData = {};
            let logMessage = [];
            
            // 1. Validation du Nom
            if (!newName) {
                showUIMessage('rename-modal-message', "Veuillez entrer un nom de joueur.", false);
                return;
            }

            // V√©rification de l'unicit√© du nom (sauf si c'est le m√™me)
            if (newName !== currentPlayer.name) {
                if (Object.values(players).some(p => p.name.toLowerCase() === newName.toLowerCase() && p.id !== playerId)) {
                     showUIMessage('rename-modal-message', "Un autre joueur porte d√©j√† ce nom.", false);
                     return;
                 }
                updateData.name = newName;
                logMessage.push(`Nom: '${currentPlayer.name}' -> '${newName}'`);
            }
            
            // 2. Validation et traitement de l'Elo
            let newElo = parseInt(newEloValue, 10);
            if (isNaN(newElo)) {
                showUIMessage('rename-modal-message', "Le score Elo doit √™tre un nombre valide.", false);
                return;
            }
            if (newElo !== currentPlayer.elo) {
                updateData.elo = newElo;
                logMessage.push(`Elo: ${currentPlayer.elo} -> ${newElo}`);
            }

            // 3. Validation et traitement des Victoires (Wins)
            let newWins = parseInt(newWinsValue, 10);
            if (isNaN(newWins) || newWins < 0) {
                showUIMessage('rename-modal-message', "Le nombre de victoires doit √™tre un nombre positif.", false);
                return;
            }
            if (newWins !== currentPlayer.wins) {
                updateData.wins = newWins;
                logMessage.push(`Victoires: ${currentPlayer.wins} -> ${newWins}`);
            }
            
            // 4. Validation et traitement des D√©faites (Losses)
            let newLosses = parseInt(newLossesValue, 10);
            if (isNaN(newLosses) || newLosses < 0) {
                showUIMessage('rename-modal-message', "Le nombre de d√©faites doit √™tre un nombre positif.", false);
                return;
            }
            if (newLosses !== currentPlayer.losses) {
                updateData.losses = newLosses;
                logMessage.push(`D√©faites: ${currentPlayer.losses} -> ${newLosses}`);
            }
            
            // 5. Validation et traitement des Parties Jou√©es (Matches)
            let newMatches = parseInt(newMatchesValue, 10);
            if (isNaN(newMatches) || newMatches < 0) {
                showUIMessage('rename-modal-message', "Le nombre de parties jou√©es doit √™tre un nombre positif.", false);
                return;
            }
            // Avertissement si Matches est incoh√©rent, mais mise √† jour si demand√©.
            if (newMatches < (newWins + newLosses)) {
                // Ce message n'arr√™te pas la fonction
                showUIMessage('rename-modal-message', "Attention: Parties Jou√©es est inf√©rieur √† Victoires + D√©faites. Mise √† jour effectu√©e.", false);
            }
            
            if (newMatches !== currentPlayer.matches) {
                updateData.matches = newMatches;
                logMessage.push(`Parties Jou√©es: ${currentPlayer.matches} -> ${newMatches}`);
            }
            
            if (Object.keys(updateData).length === 0) {
                showUIMessage('rename-modal-message', "Aucune modification d√©tect√©e.", false);
                setTimeout(() => toggleModal('rename-modal', false), 1500);
                return;
            }

            // 6. Mise √† jour Firestore
            try {
                const { setDoc, doc } = window.firebase;
                const playerRef = doc(db, getCollectionPath(), playerId);

                await setDoc(playerRef, updateData, { merge: true });

                showUIMessage('rename-modal-message', `Joueur mis √† jour: ${logMessage.join(' | ')}!`);
                setTimeout(() => toggleModal('rename-modal', false), 1500); // Ferme apr√®s succ√®s
            } catch (error) {
                console.error("Erreur lors de la modification du joueur:", error);
                showUIMessage('rename-modal-message', "Erreur: √âchec de la modification du joueur.", false);
            }
        }
        
        /**
         * Enregistre le match dans la feuille Google Sheets via Apps Script.
         */
        async function logMatchToSheet(matchData) {
            if (!GAS_WEB_APP_URL || GAS_WEB_APP_URL === "GAS_WEB_APP_URL_PLACEHOLDER") {
                console.warn("URL de l'application GAS non configur√©e. Ignorer l'enregistrement dans le Sheet.");
                return;
            }
            
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(matchData)
                });
                console.log("Requ√™te d'enregistrement de match Apps Script envoy√©e. V√©rifiez Google Sheet.");
                
            } catch (error) {
                console.error("Erreur lors de l'envoi des donn√©es √† Google Sheets:", error);
            }
        }

        /**
         * Initializes the application: loads data and renders UI.
         */
        function initializeApplication() {
            initializeFirebase();
            updateAdminUiVisibility(); 
        }

        // Initialize the app when the window loads
        window.onload = initializeApplication;
    </script>
</head>

<body class="bg-background min-h-screen font-sans">

    <!-- Header & Admin Controls -->
    <header class="bg-white shadow-md p-4 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-primary">JD Elo</h1>

            <!-- Admin Panel and Login -->
            <div class="flex items-center space-x-4">
                <!-- DB Status -->
                <div id="db-status" class="hidden text-xs font-medium px-2.5 py-0.5 rounded-full">
                    <!-- Status affich√© par JS -->
                </div>
                
                <!-- Admin Pencil Icon (Player Management) -->
                <button id="admin-pencil" onclick="togglePlayerManagementModal(true)" 
                        class="p-2 rounded-full bg-primary text-white hover:bg-primary/80 transition duration-150 shadow-lg hidden" 
                        title="G√©rer les joueurs">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                </button>

                <!-- Admin Login Button/Input -->
                <div id="admin-login-container">
                    <button onclick="toggleAdminLoginModal(true)" 
                            class="px-4 py-2 bg-indigo-500 text-white text-sm font-medium rounded-md hover:bg-indigo-600 transition duration-150 shadow-md">
                        Admin
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Loading Spinner (will hide after initial sync) -->
        <div id="loading-spinner" class="flex flex-col justify-center items-center py-20">
            <svg class="animate-spin-slow h-10 w-10 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="loading-message" class="ml-3 mt-3 text-lg text-gray-600">Initialisation de l'application...</span>
        </div>

        <!-- Match Recorder (Admin Only) - D√âPLAC√â EN HAUT -->
        <section id="match-recorder-container" class="mt-8 mb-8 hidden max-w-lg mx-auto bg-white p-6 rounded-xl shadow-2xl border border-gray-100">
            <div id="match-recorder">
                <!-- Match recorder form will be rendered here by JS -->
            </div>
        </section>

        <!-- Ranking Table Container - LAISSER ICI POUR LE CLASSEMENT PRINCIPAL -->
        <section id="ranking-list" class="mt-8">
            <!-- Ranking table and PDF button will be rendered here by JS -->
        </section>

    </main>

    <!-- --- Modals --- -->

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Connexion Admin</h3>
            <div class="mt-2">
                <input type="password" id="admin-password" placeholder="Mot de passe" 
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                
                <p id="admin-login-message" class="mt-2 text-sm text-center ui-message"></p>
            </div>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                <button onclick="handleAdminLogin()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary/80 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:col-start-2 sm:text-sm transition duration-150">
                    Se Connecter
                </button>
                <button onclick="toggleAdminLoginModal(false)" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:col-start-1 sm:text-sm transition duration-150">
                    Annuler
                </button>
            </div>
        </div>
    </div>

    <!-- Player Management Modal (Pencil Click) - Increased max-width to max-w-4xl -->
    <div id="player-management-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-6 border w-11/12 max-w-4xl shadow-2xl rounded-lg bg-white">
            <h3 class="text-2xl font-extrabold text-primary border-b pb-2 mb-4">Gestion des Joueurs</h3>
            <button onclick="togglePlayerManagementModal(false)" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Add Player Section -->
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h4 class="text-xl font-semibold mb-3 text-secondary">Ajouter un Nouveau Joueur</h4>
                    <input type="text" id="new-player-name" placeholder="Nom du joueur" 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-secondary focus:border-secondary sm:text-sm">
                    <button onclick="addPlayer()" class="mt-3 w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-secondary text-base font-medium text-white hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary sm:text-sm transition duration-150">
                        Ajouter (Elo Initial: 500)
                    </button>
                </div>

                <!-- Player List Section -->
                <div class="p-4 bg-white rounded-lg border border-gray-200">
                    <h4 class="text-xl font-semibold mb-3 text-primary">Liste & Actions (Renommer/Modifier Stats)</h4>
                    <ul id="player-list-container" class="max-h-60 overflow-y-auto space-y-1">
                        <!-- Player list will be rendered here by JS -->
                    </ul>
                </div>
            </div>
             <p id="player-management-message" class="mt-4 text-center text-sm font-medium ui-message"></p>
        </div>
    </div>
    
    <!-- Rename/Update Player Details Modal -->
    <div id="rename-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Renommer Joueur / Modifier Stats</h3>
            <div class="mt-2 space-y-4">
                <input type="hidden" id="rename-player-id">
                
                <div>
                    <label for="rename-player-name" class="block text-sm font-medium text-gray-700">Nom:</label>
                    <input type="text" id="rename-player-name" 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                </div>
                
                <div>
                    <label for="new-elo-score" class="block text-sm font-medium text-gray-700">Score Elo:</label>
                    <input type="number" id="new-elo-score" placeholder="Ex: 1500"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                </div>
                
                <div class="flex space-x-2">
                    <!-- Champ pour les Victoires (Wins) -->
                    <div class="w-1/2">
                        <label for="new-wins" class="block text-sm font-medium text-gray-700">Victoires (W):</label>
                        <input type="number" id="new-wins" placeholder="Ex: 10" min="0"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                    </div>

                    <!-- Champ pour les D√©faites (Losses) -->
                    <div class="w-1/2">
                        <label for="new-losses" class="block text-sm font-medium text-gray-700">D√©faites (L):</label>
                        <input type="number" id="new-losses" placeholder="Ex: 5" min="0"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                    </div>
                </div>

                <!-- NOUVEAU Champ pour les Parties Jou√©es (Matches) -->
                <div>
                    <label for="new-matches" class="block text-sm font-medium text-gray-700">Parties Jou√©es (Total):</label>
                    <input type="number" id="new-matches" placeholder="Ex: 18" min="0"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                    <p class="text-xs text-gray-500 mt-1">Doit √™tre sup√©rieur ou √©gal √† W + L. Inclut les matchs nuls.</p>
                </div>

                <p id="rename-modal-message" class="mt-2 text-sm text-center ui-message"></p>
            </div>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                <button onclick="updatePlayerDetails()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary/80 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:col-start-2 sm:text-sm transition duration-150">
                    Confirmer les Modifications
                </button>
                <button onclick="toggleRenameModal(false)" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:col-start-1 sm:text-sm transition duration-150">
                    Annuler
                </button>
            </div>
        </div>
    </div>
    
    <!-- Generic Confirmation Modal (Replaces standard confirm()) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Confirmation Requise</h3>
            <p id="confirmation-message" class="mt-2 text-sm text-gray-700"></p>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                <button onclick="confirmAction(true)" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:col-start-2 sm:text-sm transition duration-150">
                    Confirmer
                </button>
                <button onclick="confirmAction(false)" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:col-start-1 sm:text-sm transition duration-150">
                    Annuler
                </button>
            </div>
        </div>
    </div>
    
</body>
</html>
