<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JD Elo</title>
    <!-- Balise Favicon ajout√©e ici -->
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    
    <!-- Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import des librairies Firebase SDK v11.6.1 (ES Modules) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, query, onSnapshot, runTransaction, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase functions globally for use in the main script block
        window.firebase = {
            initializeApp,
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, setDoc, deleteDoc, collection, query, onSnapshot, runTransaction, getDoc, setLogLevel
        };
    </script>
    
    <!-- Configuration des polices et du th√®me Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5', // Indigo 600
                        'secondary': '#10b981', // Emerald 500
                        'background': '#f9fafb', // Gray 50
                        // Ajout des couleurs de podium
                        'gold': '#F5E727',
                        'silver': '#C0C0C0',
                        'bronze': '#CD7F32',
                    }
                }
            }
        }
    </script>
    <style>
        /* Animation simple de chargement pour le spinner */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        /* Style pour masquer le spinner apr√®s le chargement initial */
        #loading-spinner.hidden {
            display: none;
        }
        /* Style pour les messages de l'interface utilisateur */
        .ui-message {
            transition: opacity 0.5s ease-out;
            opacity: 1;
        }
        .ui-message.fade-out {
            opacity: 0;
        }
        /* Classe pour le texte blanc sur le bronze */
        .text-on-bronze {
            color: #f9fafb; /* White or near-white */
        }
        /* Classe pour le texte fonc√© sur l'or et l'argent */
        .text-on-light {
            color: #1f2937; /* Dark gray */
        }
        /* Rendre la colonne Rank plus large pour la streak */
        #ranking-list th:first-child, #ranking-list td:first-child {
            /* width: 150px; -- Comment√© pour laisser Tailwind g√©rer la largeur fluide */
            min-width: 120px;
        }
    </style>
    
    <script type="text/javascript">
        // Global Variables
        let players = {}; // Map to store players: { id: { id, name, elo, top1Since, ... } }
        let isAdmin = false;
        let confirmationCallback = null; // Global variable for confirmation callback
        let firebaseReady = false; // Indicates if Auth and Firestore are initialized

        // Firebase Instances
        let db;
        let auth;
        let userId = 'unknown';

        // Constants
        const INITIAL_ELO = 300; // Elo initial pour les nouveaux joueurs
        const K_FACTOR = 96; // Facteur K pour un classement 3x plus rapide
        const ADMIN_PASSWORD = "0000"; // Mot de passe admin local (ne sera pas dans Firestore)

        // Codes de couleur des m√©dailles
        const MEDAL_COLORS = {
            1: '#F5E727', // Or
            2: '#C0C0C0', // Argent
            3: '#CD7F32', // Bronze
        };
        const MEDAL_TEXT_COLOR = {
            1: 'text-on-light', // Dark text on Gold
            2: 'text-on-light', // Dark text on Silver
            3: 'text-on-bronze', // White text on Bronze
        };


        // --- Configuration Firebase (Int√©gr√©e avec vos cl√©s !) ---

        /**
         * Returns the collection path for the Elo players.
         */
        function getCollectionPath() {
            // Revenir au chemin simple car l'environnement Canvas est stable
            return `elo_players`; 
        }
        
        // Configuration Firebase (PLACEHOLDER: REMPLACEZ PAR VOTRE VRAIE CONFIG)
        const firebaseConfig = {
            apiKey: "AIzaSyDWBh3YC57FSEzzd66JhDNwgLn0S9POVtc",
            authDomain: "classement-elo.firebaseapp.com",
            projectId: "classement-elo",
            storageBucket: "classement-elo.firebasestorage.app",
            messagingSenderId: "240751765604",
            appId: "1:240751765604:web:bfc2d16d768cede61b9771",
            measurementId: "G-FREKR0HF4H"
        };
        const initialAuthToken = null; // Pas de jeton inject√© dans un d√©ploiement GitHub

        // --- Firebase Initialization and Data Sync ---

        /**
         * Initializes Firebase, performs authentication, and sets up the data listener.
         */
        async function initializeFirebase() {
            const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, getFirestore, onAuthStateChanged, setLogLevel } = window.firebase;

            if (!firebaseConfig || !firebaseConfig.apiKey) {
                document.getElementById('loading-message').textContent = "Erreur: Configurez vos cl√©s Firebase dans le code !";
                return;
            }

            try {
                // Initialisation des services
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Active le niveau de log Debug pour voir les activit√©s Firestore
                // setLogLevel('Debug'); 

                document.getElementById('loading-message').textContent = "Connexion √† Firebase...";

                // 1. Authentification
                let authPromise;
                if (initialAuthToken) {
                    // Tentative d'utilisation du jeton fourni par Canvas
                    authPromise = signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Sinon, connexion anonyme pour obtenir un userId
                    authPromise = signInAnonymously(auth);
                }
                await authPromise;
                
                // √âcoute des changements d'√©tat d'authentification
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Utilisateur authentifi√©. UID:", userId);
                        
                        // 2. Synchronisation des donn√©es (apr√®s l'authentification)
                        if (!firebaseReady) {
                            setupFirestoreListener();
                            firebaseReady = true;
                            document.getElementById('loading-spinner').classList.add('hidden');
                        }
                    } else {
                        console.log("Utilisateur d√©connect√© (anonyme ou autre).");
                    }
                });

            } catch (error) {
                console.error("Erreur d'initialisation Firebase ou d'authentification:", error);
                document.getElementById('loading-message').textContent = `Erreur de connexion Firebase: ${error.message}`;
            }
        }

        /**
         * Sets up the real-time listener for the players collection.
         */
        function setupFirestoreListener() {
            const { collection, query, onSnapshot } = window.firebase;
            
            const playersCollectionRef = collection(db, getCollectionPath());
            const q = query(playersCollectionRef);

            // √âcoute en temps r√©el des changements
            onSnapshot(q, (snapshot) => {
                const updatedPlayers = {};
                snapshot.forEach((doc) => {
                    // Firestore stocke l'ID dans doc.id, non dans le document lui-m√™me. 
                    // Ajout d'une valeur par d√©faut pour top1Since pour √©viter les erreurs.
                    updatedPlayers[doc.id] = { id: doc.id, top1Since: null, ...doc.data() };
                });
                players = updatedPlayers;
                
                const sortedPlayers = getSortedRanking(players);
                console.log("Donn√©es de classement synchronis√©es en temps r√©el.");
                
                // G√©rer la streak Top 1 apr√®s chaque mise √† jour des donn√©es
                // NOTE: Cette fonction effectue des √©critures, donc elle doit √™tre appel√©e APRES l'update de 'players'
                manageTop1Streak(sortedPlayers); 
                
                renderAll();
            }, (error) => {
                console.error("Erreur d'√©coute Firestore:", error);
                document.getElementById('match-message').textContent = "Erreur de synchronisation des donn√©es.";
                document.getElementById('match-message').className = "text-red-600 font-medium ui-message";
            });
        }
        
        /**
         * Manages the top1Since field for players to track the streak duration.
         * This runs after every data snapshot update. It is non-atomic relative to match updates.
         */
        async function manageTop1Streak(sortedPlayers) {
            if (!firebaseReady || sortedPlayers.length === 0 || !db) return;
            
            const { setDoc, doc } = window.firebase;
            
            // 1. D√©terminer le nouveau joueur Rank 1
            const newTopPlayer = sortedPlayers[0];
            const newTopId = newTopPlayer.id;

            // 2. Identifier le joueur qui *actuellement* a le top1Since (l'ancien Top 1)
            let oldTopIdWithStamp = null;
            for (const id in players) {
                // Nous lisons directement la variable globale 'players' qui contient la derni√®re version de la DB
                if (players[id].top1Since) {
                    oldTopIdWithStamp = id;
                    break;
                }
            }
            
            // 3. Mettre √† jour si le Top 1 a chang√©
            if (newTopId !== oldTopIdWithStamp) {
                
                console.log(`Changement de Rank 1 d√©tect√©: ${oldTopIdWithStamp || 'N/A'} -> ${newTopId}`);
                
                // A) R√©initialiser l'ancien Top 1 (s'il existe)
                if (oldTopIdWithStamp && players[oldTopIdWithStamp].top1Since) {
                     const oldRef = doc(db, getCollectionPath(), oldTopIdWithStamp);
                     try {
                        await setDoc(oldRef, { top1Since: null }, { merge: true });
                     } catch (e) {
                        console.error("√âchec de la r√©initialisation de l'ancien top1Since:", e);
                     }
                }

                // B) D√©finir le timestamp pour le nouveau Top 1
                const newRef = doc(db, getCollectionPath(), newTopId);
                try {
                    // Toujours d√©finir un nouveau timestamp (maintenant) pour le nouveau Top 1
                    // car il vient juste d'atteindre la place (ou le perdant vient de perdre).
                    await setDoc(newRef, { top1Since: new Date().getTime() }, { merge: true });
                } catch (e) {
                    console.error("√âchec de la d√©finition du nouveau top1Since:", e);
                }

            } else if (!newTopPlayer.top1Since) {
                 // Cas sp√©cial: Le Top 1 est le m√™me, mais le timestamp n'√©tait pas d√©fini (ex: premi√®re initialisation)
                 const newRef = doc(db, getCollectionPath(), newTopId);
                 try {
                     await setDoc(newRef, { top1Since: new Date().getTime() }, { merge: true });
                 } catch (e) {
                    console.error("√âchec de la d√©finition initiale de top1Since:", e);
                 }
            }
            // Si newTopId est le m√™me que oldTopIdWithStamp ET top1Since est d√©j√† d√©fini, rien √† faire.
        }


        // --- Elo Calculation & Utilities ---

        /**
         * Calculates the expected score of Player A against Player B.
         */
        function calculateExpectedScore(Ra, Rb) {
            return 1 / (1 + Math.pow(10, (Rb - Ra) / 400));
        }

        /**
         * Calculates the new Elo ratings after a match.
         */
        function calculateNewElos(Ra, Rb) {
            const Ea = calculateExpectedScore(Ra, Rb);
            const Eb = calculateExpectedScore(Rb, Ra);
            
            // Score Sa = 1 (Win for A), Sb = 0 (Loss for B)
            const newRa = Ra + K_FACTOR * (1 - Ea);
            const newRb = Rb + K_FACTOR * (0 - Eb);

            return { newRa: Math.round(newRa), newRb: Math.round(newRb) };
        }

        /**
         * Converts player map to a sorted array for ranking, adding win percentage.
         */
        function getSortedRanking(playerMap) {
            return Object.values(playerMap)
                .map(p => ({
                    ...p,
                    // S'assurer que top1Since est bien un nombre ou null
                    top1Since: p.top1Since && typeof p.top1Since === 'number' ? p.top1Since : null, 
                    // Calcul du pourcentage de victoires
                    winRate: p.matches > 0 ? ((p.wins / p.matches) * 100).toFixed(1) : '0.0',
                }))
                .sort((a, b) => b.elo - a.elo || a.name.localeCompare(b.name))
                .map((p, index) => ({
                    ...p,
                    rank: index + 1
                }));
        }


        // --- UI Rendering (Updated to color the top 3 rows and show streak) ---

        /**
         * Renders the main ranking table.
         */
        function renderRanking() {
            const rankingList = document.getElementById('ranking-list');
            if (!rankingList) return;

            const sortedPlayers = getSortedRanking(players);

            if (Object.keys(players).length === 0) {
                rankingList.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun joueur dans le classement pour le moment. Connectez-vous en Admin pour en ajouter.</p>';
                return;
            }

            rankingList.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 shadow-xl rounded-lg overflow-hidden">
                        <thead class="bg-primary/90 text-white">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider"># Rank / Streak</th>
                                <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider">Nom du Joueur</th>
                                <th class="px-6 py-3 text-right text-xs font-bold uppercase tracking-wider">Elo</th>
                                <!-- Colonnes num√©riques align√©es √† droite pour une meilleure lisibilit√© -->
                                <th class="px-6 py-3 text-right text-xs font-bold uppercase tracking-wider hidden sm:table-cell">Win %</th>
                                <th class="px-6 py-3 text-right text-xs font-bold uppercase tracking-wider hidden sm:table-cell">Parties Jou√©es</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            ${sortedPlayers.map(p => {
                                let rowColor = MEDAL_COLORS[p.rank] || '';
                                let textColorClass = MEDAL_TEXT_COLOR[p.rank] || 'text-gray-900';
                                
                                // Determine the row class and style
                                const rowClass = rowColor ? `shadow-inner transform hover:scale-[1.01] transition duration-150 ease-in-out` : `bg-white hover:bg-indigo-50 transition duration-150 ease-in-out`;
                                const rowStyle = rowColor ? `style="background-color: ${rowColor};"` : '';
                                
                                // Calculate days in top 1 if applicable
                                let top1DaysDisplay = '';
                                if (p.rank === 1 && p.top1Since) {
                                    const msPerDay = 1000 * 60 * 60 * 24;
                                    const days = Math.floor((new Date().getTime() - p.top1Since) / msPerDay);
                                    // Afficher "Depuis X jours" (Since X days) seulement pour Rank 1
                                    top1DaysDisplay = `<span class="text-xs font-normal ml-2 opacity-80 whitespace-nowrap"> (Depuis ${days} jours)</span>`;
                                }

                                return `
                                    <tr class="${rowClass}" ${rowStyle}>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${textColorClass}">
                                            <span class="font-bold">${p.rank === 1 ? 'ü•á' : p.rank === 2 ? 'ü•à' : p.rank === 3 ? 'ü•â' : p.rank}</span>
                                            ${top1DaysDisplay}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm ${textColorClass}">${p.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-bold ${textColorClass}">${p.elo}</td>
                                        <!-- Alignement √† droite (text-right) pour toutes les donn√©es num√©riques -->
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium ${p.winRate >= 50 ? 'text-secondary' : 'text-yellow-800'} hidden sm:table-cell">${p.winRate}%</td>
                                        <!-- Alignement √† droite (text-right) pour toutes les donn√©es num√©riques -->
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right ${textColorClass} hidden sm:table-cell">${p.matches}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        /**
         * Updates the Admin UI elements based on isAdmin state.
         */
        function updateAdminButtons() {
            const adminLogin = document.getElementById('admin-login-container');
            // MODIFICATION: S√©lectionner le conteneur du Match Recorder
            const matchRecorderContainer = document.getElementById('match-recorder-container'); 
            const adminPencil = document.getElementById('admin-pencil');
            const dbStatus = document.getElementById('db-status');

            dbStatus.classList.remove('hidden');

            if (isAdmin) {
                adminLogin.classList.add('hidden');
                // MODIFICATION: Afficher le Match Recorder
                matchRecorderContainer.classList.remove('hidden'); 
                adminPencil.classList.remove('hidden');
                dbStatus.className = "bg-primary text-white text-xs font-medium px-2.5 py-0.5 rounded-full";
                dbStatus.textContent = "‚òÅÔ∏è Mode Admin (Connect√©)";
            } else {
                adminLogin.classList.remove('hidden');
                // MODIFICATION: Masquer le Match Recorder
                matchRecorderContainer.classList.add('hidden'); 
                adminPencil.classList.add('hidden');
                dbStatus.className = "bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full";
                dbStatus.textContent = "‚òÅÔ∏è Lecture Seule";
            }
            renderMatchRecorder();
            renderPlayerManager();
        }

        /**
         * Renders the match recording form in Admin mode.
         */
        function renderMatchRecorder() {
            const matchRecorder = document.getElementById('match-recorder');
            const sortedPlayers = getSortedRanking(players);

            if (sortedPlayers.length < 2) {
                matchRecorder.innerHTML = '<p class="text-sm text-yellow-600">Ajoutez au moins deux joueurs pour enregistrer un match.</p>';
                return;
            }

            // G√©n√©rer les options, mais avec une option par d√©faut vide/d√©sactiv√©e
            const defaultOption = '<option value="" disabled selected>-- S√©lectionner --</option>';
            const playerOptions = sortedPlayers.map(p => `<option value="${p.id}">${p.name} (${p.elo})</option>`).join('');
            const optionsHtml = defaultOption + playerOptions;

            matchRecorder.innerHTML = `
                <h3 class="text-xl font-semibold mb-4 text-primary">Enregistrer un Match</h3>
                <div class="space-y-4">
                    
                    <!-- Conteneur Flex pour les deux menus d√©roulants -->
                    <div class="flex flex-col md:flex-row md:space-x-4 space-y-4 md:space-y-0">
                        
                        <!-- Section Gagnant -->
                        <div class="md:w-1/2">
                            <label for="winner-select" class="block text-sm font-medium text-gray-700">Gagnant :</label>
                            <select id="winner-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm rounded-md shadow-sm">
                                ${optionsHtml}
                            </select>
                        </div>
                        
                        <!-- Section Perdant -->
                        <div class="md:w-1/2">
                            <label for="loser-select" class="block text-sm font-medium text-gray-700">Perdant :</label>
                            <select id="loser-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm rounded-md shadow-sm">
                                ${optionsHtml}
                            </select>
                        </div>
                    </div>
                    
                    <button id="record-match-btn" onclick="recordMatch()" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-secondary hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary transition duration-150">
                        Enregistrer le R√©sultat
                    </button>
                    <div id="match-message" class="text-sm text-center ui-message"></div>
                </div>
            `;
        }

        /**
         * Renders the player management modal content.
         */
        function renderPlayerManager() {
            const playerListContainer = document.getElementById('player-list-container');
            const sortedPlayers = getSortedRanking(players);

            // Populate current players for rename/remove
            playerListContainer.innerHTML = sortedPlayers.map(p => `
                <li class="flex items-center justify-between py-2 border-b border-gray-100">
                    <span class="text-gray-700">${p.name} (Elo: ${p.elo})</span>
                    <div class="space-x-2">
                        <button onclick="document.getElementById('rename-player-id').value='${p.id}'; document.getElementById('rename-player-name').value='${p.name}'; document.getElementById('new-elo-score').value='${p.elo}'; toggleRenameModal(true);"
                                class="text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-100 transition duration-150" title="Renommer / Modifier Elo">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        </button>
                        <button onclick="confirmRemovePlayer('${p.id}', '${p.name}')"
                                class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition duration-150" title="Supprimer">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </li>
            `).join('') || '<p class="text-gray-500">Aucun joueur √† g√©rer.</p>';
        }

        /**
         * Renders all dynamic parts of the UI.
         */
        function renderAll() {
             renderRanking();
             renderMatchRecorder();
             renderPlayerManager();
             updateAdminButtons();
        }

        /**
         * Utility function to display success/error messages in the UI.
         */
        function showUIMessage(elementId, message, isSuccess = true) {
            const messageElement = document.getElementById(elementId);
            if (!messageElement) return;

            messageElement.textContent = message;
            messageElement.className = `text-sm text-center ui-message ${isSuccess ? 'text-green-600' : 'text-red-600'} font-medium`;
            
            // Fade out the message after 5 seconds
            setTimeout(() => {
                messageElement.classList.add('fade-out');
                setTimeout(() => {
                    messageElement.textContent = '';
                    messageElement.classList.remove('fade-out');
                }, 500); // Wait for transition to finish
            }, 5000);
        }

        // --- Modal Handling ---

        /**
         * Toggles the visibility of any modal.
         */
        function toggleModal(modalId, show) {
            const modal = document.getElementById(modalId);
            if (modal) {
                if (show) {
                    modal.classList.remove('hidden');
                } else {
                    modal.classList.add('hidden');
                }
            }
        }
        
        /**
         * Shows the generic confirmation modal.
         */
        function showConfirmationModal(message, callback) {
            confirmationCallback = callback;
            document.getElementById('confirmation-message').textContent = message;
            toggleModal('confirmation-modal', true);
        }

        // Expose functions to global scope for HTML event handlers (onclick)
        window.togglePlayerManagementModal = (show) => toggleModal('player-management-modal', show);
        window.toggleRenameModal = (show) => toggleModal('rename-modal', show);
        window.toggleAdminLoginModal = (show) => toggleModal('admin-login-modal', show);
        
        /**
         * Executes the confirmation callback if confirmed and hides the modal.
         */
        window.confirmAction = (confirmed) => {
            toggleModal('confirmation-modal', false);
            if (confirmed && confirmationCallback) {
                confirmationCallback();
            }
            confirmationCallback = null;
        }


        // --- Admin Actions ---

        /**
         * Handles the Admin Login process.
         */
        window.handleAdminLogin = function() {
            const passwordInput = document.getElementById('admin-password');
            const password = passwordInput.value;
            const messageElement = document.getElementById('admin-login-message');

            if (password === ADMIN_PASSWORD) {
                isAdmin = true;
                messageElement.textContent = "Mode Administrateur activ√©.";
                messageElement.className = "text-green-600 text-sm";
                passwordInput.value = '';
                toggleModal('admin-login-modal', false);
                updateAdminButtons();
            } else {
                messageElement.textContent = "Mot de passe incorrect.";
                messageElement.className = "text-red-600 text-sm";
            }
        }

        /**
         * Adds a new player to Firestore.
         */
        window.addPlayer = async function() {
            if (!isAdmin || !firebaseReady) return;
            
            const playerNameInput = document.getElementById('new-player-name');
            const playerName = playerNameInput.value.trim();
            const messageElement = document.getElementById('player-management-message');

            if (!playerName) {
                showUIMessage('player-management-message', "Veuillez entrer un nom de joueur.", false);
                return;
            }

            if (Object.values(players).some(p => p.name.toLowerCase() === playerName.toLowerCase())) {
                showUIMessage('player-management-message', "Ce joueur existe d√©j√†.", false);
                return;
            }

            try {
                // Firestore attribue l'ID automatiquement, mais nous le d√©finissons pour la clart√©
                const { setDoc, doc, collection } = window.firebase;
                const newPlayerRef = doc(collection(db, getCollectionPath())); 
                const newPlayer = {
                    name: playerName,
                    elo: INITIAL_ELO,
                    wins: 0,
                    losses: 0,
                    matches: 0,
                    createdAt: new Date().getTime(),
                    top1Since: null, // Nouveau champ initialis√© √† null
                    createdBy: userId 
                };
                
                await setDoc(newPlayerRef, newPlayer);

                playerNameInput.value = '';
                showUIMessage('player-management-message', `Joueur '${playerName}' ajout√© avec succ√®s!`);
            } catch (error) {
                console.error("Erreur lors de l'ajout du joueur:", error);
                showUIMessage('player-management-message', "Erreur: √âchec de l'ajout du joueur (v√©rifiez les r√®gles Firestore).", false);
            }
        }

        /**
         * Prompts and handles player removal confirmation using the custom modal.
         */
        window.confirmRemovePlayer = (playerId, playerName) => {
            showConfirmationModal(
                `√ätes-vous s√ªr de vouloir supprimer le joueur '${playerName}'? Cette action est irr√©versible.`,
                () => removePlayer(playerId)
            );
        };


        /**
         * Removes a player from Firestore.
         */
        async function removePlayer(playerId) {
            if (!isAdmin || !firebaseReady) return;
            
            try {
                const { deleteDoc, doc } = window.firebase;
                await deleteDoc(doc(db, getCollectionPath(), playerId));
                
                showUIMessage('player-management-message', "Joueur supprim√© avec succ√®s!");
            } catch (error) {
                 console.error("Erreur lors de la suppression du joueur:", error);
                 showUIMessage('player-management-message', "Erreur: √âchec de la suppression du joueur.", false);
            }
        }

        /**
         * Renames a player and/or changes their Elo in Firestore.
         */
        window.updatePlayerDetails = async function() {
            if (!isAdmin || !firebaseReady) return;
            
            const playerId = document.getElementById('rename-player-id').value;
            const newName = document.getElementById('rename-player-name').value.trim();
            const newEloValue = document.getElementById('new-elo-score').value.trim();
            const messageElement = document.getElementById('rename-modal-message');

            const currentPlayer = players[playerId];
            if (!currentPlayer) {
                 showUIMessage('rename-modal-message', "Erreur: Joueur introuvable pour la modification.", false);
                 return;
            }
            
            let updateData = {};
            let logMessage = [];
            
            // 1. Validation du Nom
            if (!newName) {
                showUIMessage('rename-modal-message', "Veuillez entrer un nom de joueur.", false);
                return;
            }

            // V√©rification de l'unicit√© du nom (sauf si c'est le m√™me)
            if (newName !== currentPlayer.name) {
                if (Object.values(players).some(p => p.name.toLowerCase() === newName.toLowerCase() && p.id !== playerId)) {
                     showUIMessage('rename-modal-message', "Un autre joueur porte d√©j√† ce nom.", false);
                     return;
                 }
                updateData.name = newName;
                logMessage.push(`Nom: '${currentPlayer.name}' -> '${newName}'`);
            }
            
            // 2. Validation et traitement de l'Elo
            let newElo = parseInt(newEloValue, 10);
            
            // newEloValue devrait toujours √™tre le current Elo si non modifi√© (car pr√©-rempli)
            if (isNaN(newElo)) {
                showUIMessage('rename-modal-message', "Le score Elo doit √™tre un nombre valide.", false);
                return;
            }

            if (newElo !== currentPlayer.elo) {
                updateData.elo = newElo;
                logMessage.push(`Elo: ${currentPlayer.elo} -> ${newElo}`);
            }
            
            if (Object.keys(updateData).length === 0) {
                showUIMessage('rename-modal-message', "Aucune modification d√©tect√©e.", false);
                setTimeout(() => toggleModal('rename-modal', false), 1500);
                return;
            }

            // 3. Mise √† jour Firestore
            try {
                const { setDoc, doc } = window.firebase;
                const playerRef = doc(db, getCollectionPath(), playerId);

                // Utiliser setDoc avec merge:true pour mettre √† jour uniquement les champs dans updateData
                await setDoc(playerRef, updateData, { merge: true });

                showUIMessage('rename-modal-message', `Joueur mis √† jour: ${logMessage.join(' et ')}!`);
                setTimeout(() => toggleModal('rename-modal', false), 1500); // Ferme apr√®s succ√®s
            } catch (error) {
                console.error("Erreur lors de la modification du joueur:", error);
                showUIMessage('rename-modal-message', "Erreur: √âchec de la modification du joueur.", false);
            }
        }

        /**
         * Handles the recording of a match result and updates player Elo using a transaction.
         */
        window.recordMatch = async function() {
            if (!isAdmin || !firebaseReady) return;
            
            const winnerId = document.getElementById('winner-select').value;
            const loserId = document.getElementById('loser-select').value;

            if (!winnerId || !loserId) {
                showUIMessage('match-message', "Veuillez s√©lectionner le gagnant et le perdant.", false);
                return;
            }

            if (winnerId === loserId) {
                showUIMessage('match-message', "Le gagnant et le perdant doivent √™tre diff√©rents.", false);
                return;
            }
            
            const winnerData = players[winnerId];
            const loserData = players[loserId];

            if (!winnerData || !loserData) {
                showUIMessage('match-message', "Erreur: Joueur introuvable.", false);
                return;
            }

            try {
                const { runTransaction, doc } = window.firebase;
                let eloChangeWinner, eloChangeLoser;

                await runTransaction(db, async (transaction) => {
                    // 1. Lire les documents les plus r√©cents dans la transaction
                    const winnerRef = doc(db, getCollectionPath(), winnerId);
                    const loserRef = doc(db, getCollectionPath(), loserId);
                    
                    const winnerSnapshot = await transaction.get(winnerRef);
                    const loserSnapshot = await transaction.get(loserRef);

                    if (!winnerSnapshot.exists() || !loserSnapshot.exists()) {
                        throw "Les documents du joueur n'existent pas ou ont √©t√© supprim√©s.";
                    }

                    const currentWinnerElo = winnerSnapshot.data().elo;
                    const currentLoserElo = loserSnapshot.data().elo;
                    
                    // 2. Calculer les nouveaux Elos
                    const { newRa, newRb } = calculateNewElos(currentWinnerElo, currentLoserElo);

                    eloChangeWinner = newRa - currentWinnerElo;
                    eloChangeLoser = newRb - currentLoserElo;

                    // 3. Mettre √† jour les donn√©es du gagnant
                    transaction.set(winnerRef, { 
                        elo: newRa, 
                        wins: winnerSnapshot.data().wins + 1, 
                        matches: winnerSnapshot.data().matches + 1 
                    }, { merge: true });
                    
                    // 4. Mettre √† jour les donn√©es du perdant
                    transaction.set(loserRef, { 
                        elo: newRb, 
                        losses: loserSnapshot.data().losses + 1, 
                        matches: loserSnapshot.data().matches + 1 
                    }, { merge: true });
                });
                
                // Si la transaction r√©ussit, afficher le message
                showUIMessage('match-message', `Match enregistr√©! ${winnerData.name} gagne (+${eloChangeWinner}) contre ${loserData.name} (${eloChangeLoser}).`);

            } catch (e) {
                console.error("Erreur lors de l'enregistrement du match (Transaction √©chou√©e): ", e);
                showUIMessage('match-message', `Erreur lors de l'enregistrement du match : V√©rifiez la console.`, false);
            }
        }


        /**
         * Initializes the application: loads data and renders UI.
         */
        function initializeApplication() {
            // D√©marre l'initialisation de Firebase (qui s'occupe de la sync de donn√©es)
            initializeFirebase();
            updateAdminButtons(); // Pour montrer les boutons d'admin d√®s le d√©part
        }

        // Initialize the app when the window loads
        window.onload = initializeApplication;
    </script>
</head>

<body class="bg-background min-h-screen font-sans">

    <!-- Header & Admin Controls -->
    <header class="bg-white shadow-md p-4 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-primary">JD Elo</h1>

            <!-- Admin Panel and Login -->
            <div class="flex items-center space-x-4">
                <!-- DB Status -->
                <div id="db-status" class="hidden text-xs font-medium px-2.5 py-0.5 rounded-full">
                    <!-- Status affich√© par JS -->
                </div>
                
                <!-- Admin Pencil Icon (Player Management) -->
                <button id="admin-pencil" onclick="togglePlayerManagementModal(true)" 
                        class="p-2 rounded-full bg-primary text-white hover:bg-primary/80 transition duration-150 shadow-lg hidden" 
                        title="G√©rer les joueurs">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                </button>

                <!-- Admin Login Button/Input -->
                <div id="admin-login-container">
                    <button onclick="toggleAdminLoginModal(true)" 
                            class="px-4 py-2 bg-indigo-500 text-white text-sm font-medium rounded-md hover:bg-indigo-600 transition duration-150 shadow-md">
                        Admin
                    </button>
                </div>
            </div>
        </div>
        <!-- L'affichage de l'ID utilisateur a √©t√© retir√© pour l'ergonomie -->
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Loading Spinner (will hide after initial sync) -->
        <div id="loading-spinner" class="flex flex-col justify-center items-center py-20">
            <svg class="animate-spin-slow h-10 w-10 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="loading-message" class="ml-3 mt-3 text-lg text-gray-600">Initialisation de l'application...</span>
        </div>

        <!-- Match Recorder (Admin Only) - D√âPLAC√â EN HAUT -->
        <section id="match-recorder-container" class="mt-8 mb-8 hidden max-w-lg mx-auto bg-white p-6 rounded-xl shadow-2xl border border-gray-100">
            <div id="match-recorder">
                <!-- Match recorder form will be rendered here by JS -->
            </div>
        </section>

        <!-- Ranking Table Container - LAISSER ICI POUR LE CLASSEMENT PRINCIPAL -->
        <section id="ranking-list" class="mt-8">
            <!-- Ranking table will be rendered here by JS -->
        </section>

    </main>

    <!-- --- Modals --- -->

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Connexion Admin</h3>
            <div class="mt-2">
                <input type="password" id="admin-password" placeholder="Mot de passe" 
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                
                <p id="admin-login-message" class="mt-2 text-sm text-center ui-message"></p>
            </div>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                <button onclick="handleAdminLogin()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary/80 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:col-start-2 sm:text-sm transition duration-150">
                    Se Connecter
                </button>
                <button onclick="toggleAdminLoginModal(false)" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:col-start-1 sm:text-sm transition duration-150">
                    Annuler
                </button>
            </div>
        </div>
    </div>

    <!-- Player Management Modal (Pencil Click) - Increased max-width to max-w-4xl -->
    <div id="player-management-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-6 border w-11/12 max-w-4xl shadow-2xl rounded-lg bg-white">
            <h3 class="text-2xl font-extrabold text-primary border-b pb-2 mb-4">Gestion des Joueurs</h3>
            <button onclick="togglePlayerManagementModal(false)" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Add Player Section -->
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h4 class="text-xl font-semibold mb-3 text-secondary">Ajouter un Nouveau Joueur</h4>
                    <input type="text" id="new-player-name" placeholder="Nom du joueur" 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-secondary focus:border-secondary sm:text-sm">
                    <button onclick="addPlayer()" class="mt-3 w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-secondary text-base font-medium text-white hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary sm:text-sm transition duration-150">
                        Ajouter (Elo Initial: 300)
                    </button>
                </div>

                <!-- Player List Section -->
                <div class="p-4 bg-white rounded-lg border border-gray-200">
                    <h4 class="text-xl font-semibold mb-3 text-primary">Liste & Actions (Renommer/Supprimer)</h4>
                    <ul id="player-list-container" class="max-h-60 overflow-y-auto space-y-1">
                        <!-- Player list will be rendered here by JS -->
                    </ul>
                </div>
            </div>
             <p id="player-management-message" class="mt-4 text-center text-sm font-medium ui-message"></p>
        </div>
    </div>
    
    <!-- Rename/Update Player Details Modal -->
    <div id="rename-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Renommer Joueur / Modifier Elo</h3>
            <div class="mt-2 space-y-4">
                <input type="hidden" id="rename-player-id">
                
                <div>
                    <label for="rename-player-name" class="block text-sm font-medium text-gray-700">Nouveau Nom:</label>
                    <input type="text" id="rename-player-name" 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                </div>
                
                <div>
                    <!-- Ligne modifi√©e ici : suppression de "CHAUDER ELO" -->
                    <label for="new-elo-score" class="block text-sm font-medium text-gray-700">Nouvel Elo:</label>
                    <input type="number" id="new-elo-score" placeholder="Ex: 1500"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                </div>

                <p id="rename-modal-message" class="mt-2 text-sm text-center ui-message"></p>
            </div>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                <button onclick="updatePlayerDetails()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary/80 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:col-start-2 sm:text-sm transition duration-150">
                    Confirmer les Modifications
                </button>
                <button onclick="toggleRenameModal(false)" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:col-start-1 sm:text-sm transition duration-150">
                    Annuler
                </button>
            </div>
        </div>
    </div>
    
    <!-- Generic Confirmation Modal (Replaces standard confirm()) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Confirmation Requise</h3>
            <p id="confirmation-message" class="mt-2 text-sm text-gray-700"></p>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                <button onclick="confirmAction(true)" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:col-start-2 sm:text-sm transition duration-150">
                    Confirmer
                </button>
                <button onclick="confirmAction(false)" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:col-start-1 sm:text-sm transition duration-150">
                    Annuler
                </button>
            </div>
        </div>
    </div>
    
</body>
</html>
